<%= error_messages_for 'request_tosca' %>

<% new_request = case controller.action_name
     when 'new', 'create' then true
     else false
   end %>

<div class="subcolumns">
  <div class="c50l">
  <div class="show">
    <table>

      <tr>
        <th><label for="request_typerequest_id"><%= _("Type") %></label></th>
        <td><%= select(:request, :typerequest_id, @typerequests) %>
          <% if new_request %>
            <%= select(:request, :severite_id, @severites) %>
          <% end %>
        </td>
      </tr>

      <tr>
        <th><label for="request_contract_id"><%= _("Concerning") %></label></th>

        <% if @contracts.size > 1 %>
          <td>
            <% if @ingenieur %>
              <%# We have an empty to make sure YOU choose the contract %>
              <%= select_empty(:request, :contract_id, @contracts) %>
            <% elsif @recipient %>
              <%= select(:request, :contract_id, @contracts) %>
            <% end %>

            <% options = PagesHelper::SPINNER_OPTIONS.dup.update(:with => "contract_id",
                 :url => ajax_display_contract_requests_path) %>
            <%= observe_field "request_contract_id", options %>
          </td>
        <% elsif @contracts.size == 1 %>
          <td colspan="2">
            <%# we ensure script kiddie can not pervert this field on the server side %>
            <%= @contracts.first.first %>
            <%= hidden_field(:request, :contract_id, :value => @contracts.first.last) %>
          </td>
        <% else %>
          <td colspan="2"></td>
        <% end %>
      </tr>

      <tr>
        <th><label for="request_recipient_id"><%= _("Recipient") %></label></th>
        <%# Warning, the code of this cell is also in ajax_display_contract.rjs %>
        <td><div id="recipient"><%= select(:request, :recipient_id, @recipients) %></div></td>
      </tr>

      <% if @ingenieur %>
      <tr>
        <th><label for="request_ingenieur_id"><%=_("Assigned to")%></label></th>
        <td>
          <div id="engineer">
            <select id="request_ingenieur_id" name="request[ingenieur_id]"><option value="">Â» </option>
              <%= options_from_collection_for_select(@ingenieurs, :last, :first, @request_tosca.ingenieur_id) %>
              <%= option_groups_from_collection_for_select(@teams, :engineers_collection_select, :name, :id, :name, @request_tosca.ingenieur_id) %>
            </select>
          </div>
        </td>
      </tr>
      <% end %>

      <tr>
        <td colspan="2"><hr /></td>
      </tr>

      <tr>
        <th><label for="request_logiciel_id"><%= _("Software") %></label></th>
        <td><%= render :partial => 'logiciel' %></td>
      </tr>

      <tr id="version">
        <%= render :partial => 'version' %>
      </tr>

      <% if @ingenieur %>
      <tr>
        <td colspan="2"><hr /></td>
      </tr>

      <tr>
        <th><label for="request_mail_cc"><%= _("CC") %></label></th>
        <td><%= text_field :request, :mail_cc, :size => 20 %></td>
      </tr>

      <% unless new_request %>
      <tr>
        <th><label for="request_expected_on"><%= _("Request|Expected on") %></label></th>
        <td>
          <%= text_field :request, :expected_on, :size => 20 %>
          <span class="calendarPicker"><%= StaticScript::date_from %></span>
          <%= StaticScript::script_date('request_expected_on', 'date_from') %>
        </td>
      </tr>
      <% end %>
      <% end %>

      <tr>
        <td colspan="2"><hr /></td>
      </tr>

      <tr>
        <th><%= _("Commitments") %></th>
        <td><div id="commitment"><%= display_commitment(@request_tosca)%></div></td>
      </tr>
    </table>
  </div>
</div>

<div class="c50r">
  <div class="show">
  <table>
    <tr>
      <th colspan="2"><label for="request_resume"><%= _("Summary") %></label></th>
    </tr>
    <tr>
      <td colspan="2"><%= text_field :request, :resume, :size => 45, :maxlength => 70 %></td>
    </tr>

    <tr>
      <td colspan="2">
        <fieldset style="width: 45em;">
          <legend><%=  _("Detailed description") %></legend>
          <%= text_area 'request', 'description', :cols => 55, :rows =>17 %>
        </fieldset>
      </td>
    </tr>

    <tr>
    <% if new_request %>
      <th colspan="2"><label for="attachment_file"><%= _("Add a file") %></label></th>
    </tr>

    <tr>
      <td colspan="2"><%= file_column_field 'attachment', 'file', :size => 40 %></td>
    <% else %>
      <td colspan="2"></td>
    <% end %>
    </tr>

  </table>
</div>
</div>

</div>

<% fields = %w(request_typerequest_id) %>
<% fields << 'request_contract_id' if @contracts.size > 1 %>
<% fields << 'request_severite_id' if new_request %>
<% options = PagesHelper::SPINNER_OPTIONS.dup.update(:with =>
     "Form.serializeElements($('#{fields.join("','")}'))",
     :url => ajax_display_commitment_requests_path) %>
<% fields.each do |field| %>
  <%= observe_field field, options %>
<% end %>
